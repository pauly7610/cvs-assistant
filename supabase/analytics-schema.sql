-- Analytics Schema for User Journey Tracking
-- All IDs auto-generated by Supabase

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ============================================
-- ANALYTICS EVENTS
-- ============================================
CREATE TABLE IF NOT EXISTS analytics_events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id TEXT NOT NULL,
  session_id TEXT NOT NULL,
  event_type TEXT NOT NULL,
  event_name TEXT NOT NULL,
  event_data JSONB DEFAULT '{}',
  page_path TEXT,
  referrer TEXT,
  user_agent TEXT,
  device_type TEXT CHECK (device_type IN ('mobile', 'tablet', 'desktop')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_analytics_user ON analytics_events(user_id);
CREATE INDEX IF NOT EXISTS idx_analytics_session ON analytics_events(session_id);
CREATE INDEX IF NOT EXISTS idx_analytics_type ON analytics_events(event_type);
CREATE INDEX IF NOT EXISTS idx_analytics_created ON analytics_events(created_at);

-- ============================================
-- USER SESSIONS
-- ============================================
CREATE TABLE IF NOT EXISTS user_sessions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id TEXT UNIQUE NOT NULL,
  user_id TEXT NOT NULL,
  started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  ended_at TIMESTAMP WITH TIME ZONE,
  duration_seconds INTEGER,
  page_views INTEGER DEFAULT 0,
  events_count INTEGER DEFAULT 0,
  messages_sent INTEGER DEFAULT 0,
  intents_triggered JSONB DEFAULT '[]',
  device_type TEXT,
  browser TEXT,
  os TEXT,
  is_authenticated BOOLEAN DEFAULT false,
  entry_page TEXT,
  exit_page TEXT
);

CREATE INDEX IF NOT EXISTS idx_sessions_user ON user_sessions(user_id);

-- ============================================
-- CONVERSATION ANALYTICS
-- ============================================
CREATE TABLE IF NOT EXISTS conversation_analytics (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  conversation_id UUID,
  user_id TEXT NOT NULL,
  session_id TEXT NOT NULL,
  started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  ended_at TIMESTAMP WITH TIME ZONE,
  message_count INTEGER DEFAULT 0,
  user_message_count INTEGER DEFAULT 0,
  assistant_message_count INTEGER DEFAULT 0,
  intents JSONB DEFAULT '[]',
  escalated BOOLEAN DEFAULT false,
  escalation_reason TEXT,
  resolved BOOLEAN DEFAULT false,
  satisfaction_score INTEGER CHECK (satisfaction_score >= 1 AND satisfaction_score <= 5),
  first_response_time_ms INTEGER,
  avg_response_time_ms INTEGER
);

-- ============================================
-- FUNNEL EVENTS
-- ============================================
CREATE TABLE IF NOT EXISTS funnel_events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id TEXT NOT NULL,
  session_id TEXT NOT NULL,
  funnel_name TEXT NOT NULL,
  step_name TEXT NOT NULL,
  step_order INTEGER NOT NULL,
  completed BOOLEAN DEFAULT false,
  dropped_off BOOLEAN DEFAULT false,
  time_in_step_ms INTEGER,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_funnel_name ON funnel_events(funnel_name);

-- ============================================
-- FEATURE USAGE
-- ============================================
CREATE TABLE IF NOT EXISTS feature_usage (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id TEXT NOT NULL,
  feature_name TEXT NOT NULL,
  usage_count INTEGER DEFAULT 1,
  first_used_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_used_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, feature_name)
);

-- ============================================
-- ERROR LOGS
-- ============================================
CREATE TABLE IF NOT EXISTS error_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id TEXT,
  session_id TEXT,
  error_type TEXT NOT NULL,
  error_message TEXT NOT NULL,
  stack_trace TEXT,
  page_path TEXT,
  component TEXT,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ============================================
-- SEED DATA (no explicit IDs)
-- ============================================
INSERT INTO analytics_events (user_id, session_id, event_type, event_name, event_data, page_path, device_type, created_at) VALUES
('user_demo', 'sess_001', 'page_view', 'Page Viewed', '{}', '/', 'desktop', NOW() - INTERVAL '1 day'),
('user_demo', 'sess_001', 'chat_started', 'Chat Started', '{}', '/', 'desktop', NOW() - INTERVAL '1 day'),
('user_demo', 'sess_001', 'intent_triggered', 'Intent Triggered', '{"intent": "prescription_status"}', '/', 'desktop', NOW() - INTERVAL '1 day'),
('user_demo', 'sess_002', 'page_view', 'Page Viewed', '{}', '/', 'mobile', NOW() - INTERVAL '2 days'),
('user_demo', 'sess_002', 'intent_triggered', 'Intent Triggered', '{"intent": "refill_request"}', '/', 'mobile', NOW() - INTERVAL '2 days'),
('user_demo2', 'sess_003', 'page_view', 'Page Viewed', '{}', '/', 'desktop', NOW() - INTERVAL '3 days'),
('user_demo2', 'sess_003', 'intent_triggered', 'Intent Triggered', '{"intent": "symptom_intake"}', '/', 'desktop', NOW() - INTERVAL '3 days'),
('user_demo2', 'sess_003', 'pharmacist_escalation', 'Escalation', '{"reason": "complex"}', '/', 'desktop', NOW() - INTERVAL '3 days'),
('user_demo3', 'sess_004', 'page_view', 'Page Viewed', '{}', '/', 'mobile', NOW() - INTERVAL '4 days'),
('user_demo3', 'sess_004', 'emergency_triggered', 'Emergency', '{"keyword": "chest pain"}', '/', 'mobile', NOW() - INTERVAL '4 days');

INSERT INTO user_sessions (session_id, user_id, page_views, events_count, messages_sent, device_type, is_authenticated, started_at) VALUES
('sess_001', 'user_demo', 1, 3, 2, 'desktop', true, NOW() - INTERVAL '1 day'),
('sess_002', 'user_demo', 1, 2, 1, 'mobile', true, NOW() - INTERVAL '2 days'),
('sess_003', 'user_demo2', 1, 3, 2, 'desktop', true, NOW() - INTERVAL '3 days'),
('sess_004', 'user_demo3', 1, 2, 1, 'mobile', true, NOW() - INTERVAL '4 days');

INSERT INTO funnel_events (user_id, session_id, funnel_name, step_name, step_order, completed) VALUES
('user_demo', 'sess_001', 'prescription_check', 'start', 1, true),
('user_demo', 'sess_001', 'prescription_check', 'view_status', 2, true),
('user_demo', 'sess_002', 'refill_flow', 'start', 1, true),
('user_demo', 'sess_002', 'refill_flow', 'submit', 2, true),
('user_demo2', 'sess_003', 'symptom_flow', 'start', 1, true),
('user_demo2', 'sess_003', 'symptom_flow', 'escalate', 2, true);

INSERT INTO feature_usage (user_id, feature_name, usage_count) VALUES
('user_demo', 'prescription_status', 5),
('user_demo', 'refill_request', 3),
('user_demo2', 'symptom_intake', 2),
('user_demo2', 'book_appointment', 3),
('user_demo3', 'prescription_status', 4);

INSERT INTO conversation_analytics (user_id, session_id, message_count, user_message_count, assistant_message_count, intents, escalated, resolved, first_response_time_ms) VALUES
('user_demo', 'sess_001', 4, 2, 2, '["prescription_status"]', false, true, 450),
('user_demo', 'sess_002', 4, 2, 2, '["refill_request"]', false, true, 380),
('user_demo2', 'sess_003', 6, 3, 3, '["symptom_intake"]', true, true, 520),
('user_demo3', 'sess_004', 2, 1, 1, '["emergency"]', true, true, 180);
